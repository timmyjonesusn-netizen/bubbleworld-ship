<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TimmyTime • Bubble World Ship — Pretty Pack v1.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<base href="/bubbleworld-ship/">

<style>
  :root{
    --bg:#05000c;
    --ink:#fefefe;
    --glass:rgba(255,255,255,.10);
    --radius:16px;
    --title-size: clamp(2rem, 6vw, 3rem);
    --body-size:  clamp(1.05rem, 4vw, 1.5rem);
  }
  *{ box-sizing:border-box; }
  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--ink);
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }
  a{ color:inherit; }

  /* FX layers never intercept taps */
  .fx-layer{ position:fixed; inset:0; pointer-events:none; z-index:0; }

  main{ position:relative; z-index:1; min-height:100dvh; }
  [data-room]{ display:none; min-height:100dvh; padding:10vh 6vw 16vh; }
  [data-room].on{ display:block; }

  /* Soft halo + vignette using room accent */
  .halo{
    position:fixed; inset:0; z-index:0; pointer-events:none;
    background:
      radial-gradient(44vmin 44vmin at 50% 42%, var(--accent-18) 0%, transparent 66%),
      radial-gradient(120vmax 100vmax at 50% 120%, rgba(0,0,0,.55) 0%, rgba(0,0,0,0) 30%),
      radial-gradient(100vmax 100vmax at -10% -10%, rgba(0,0,0,.35) 0%, rgba(0,0,0,0) 32%),
      radial-gradient(100vmax 100vmax at 110% -10%, rgba(0,0,0,.35) 0%, rgba(0,0,0,0) 32%);
  }

  .title{ font-size:var(--title-size); line-height:1.1; letter-spacing:.5px; margin:0 0 .25rem; text-align:center; }
  .subtitle{ font-size: clamp(1rem, 3.5vw, 1.25rem); opacity:.9; text-align:center; margin:0 0 2rem; }

  .brand{
    width:min(1100px,92vw); margin:.25rem auto 1rem; text-align:center; font-weight:800; letter-spacing:1px;
    color:var(--accent); text-shadow:0 0 18px var(--accent-60);
    font-size: clamp(1.1rem, 4.6vw, 1.8rem);
  }

  .stage{
    width:min(1100px,92vw); margin:0 auto 1rem; aspect-ratio:16/9; border-radius:var(--radius);
    overflow:hidden; background:#000; outline:1px solid var(--accent-28);
    box-shadow: 0 10px 40px rgba(0,0,0,.5), 0 0 24px var(--accent-10);
    position:relative;
  }
  .stage iframe{ width:100%; height:100%; border:0; display:block; }

  .joke{
    width:min(1100px,92vw); margin:.6rem auto 0; padding:.8rem 1rem; border-radius:12px;
    background:var(--glass); backdrop-filter: blur(6px);
    font-size:var(--body-size);
  }

  /* Suno Links block */
  .links{
    width:min(1100px,92vw); margin:.8rem auto 0; padding:0; list-style:none;
    display:grid; gap:.5rem;
  }
  .links a{
    display:block; text-decoration:none; padding:.7rem .9rem; border-radius:10px;
    background:rgba(255,255,255,.06); backdrop-filter: blur(6px);
    outline:1px solid var(--accent-18);
    font-size: clamp(0.95rem, 3.4vw, 1.2rem);
  }
  .links a:hover{ background:rgba(255,255,255,.10); }

  /* Arrows raised ~25vh */
  .arrow{
    position:fixed; bottom:25vh;
    font-size: clamp(2rem, 8vw, 3rem); text-decoration:none; color:var(--ink);
    padding:.35rem .6rem; border-radius:.5rem; background: var(--glass);
    backdrop-filter: blur(6px); z-index:9999; user-select:none;
  }
  .arrow.left{ left:1rem; }
  .arrow.right{ right:1rem; }
  .arrow:active{ transform: scale(.98); }

  /* Plus button: sits BELOW the joke (out of frame for your screen recordings) */
  .plus-wrap{
    width:min(1100px,92vw); margin:.8rem auto 0; display:flex; justify-content:flex-end;
  }
  .plus-btn{
    display:inline-flex; align-items:center; gap:.5rem; cursor:pointer;
    padding:.55rem .8rem; border-radius:999px; border:1px solid var(--accent-18);
    background:rgba(255,255,255,.06); backdrop-filter: blur(6px);
    font-size: clamp(.95rem,3.2vw,1.05rem); user-select:none;
  }
  .plus-btn .dot{ font-size:1.3em; line-height:1; }

  /* Input sheet (collapsible) */
  .sheet{
    width:min(1100px,92vw); margin:.6rem auto 0; border-radius:12px; overflow:hidden;
    background:rgba(255,255,255,.06); backdrop-filter: blur(8px);
    border:1px solid var(--accent-18); display:none;
  }
  .sheet.on{ display:block; }
  .sheet-inner{ padding:.8rem; display:grid; gap:.6rem; }
  .sheet label{ font-size:.95rem; opacity:.9; }
  .sheet input{
    width:100%; padding:.7rem .9rem; border-radius:10px; border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.35); color:#fff; font-size:1rem;
  }
  .sheet .actions{ display:flex; gap:.6rem; flex-wrap:wrap; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.5rem; cursor:pointer;
    padding:.6rem .9rem; border-radius:10px; border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.07);
    font-size:1rem; user-select:none; text-decoration:none; color:#fff;
  }
  .btn.primary{ border-color:var(--accent-28); box-shadow: 0 0 12px var(--accent-10) inset; }
  .hint{ font-size:.9rem; opacity:.8; }

  /* Toast */
  #ship-toast{
    position:fixed; left:50%; bottom:8vh; transform:translateX(-50%);
    padding:10px 14px; border-radius:10px; z-index:99999;
    background:rgba(0,0,0,.55); color:#fff; backdrop-filter: blur(6px);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-size:14px; opacity:0; transition:opacity .2s ease;
  }

  /* Room themes (CSS vars) */
  .room-engine  { --accent:#35ff9c; --accent-60:rgba(53,255,156,.60); --accent-28:rgba(53,255,156,.28); --accent-18:rgba(53,255,156,.18); --accent-10:rgba(53,255,156,.10); }
  .room-purple  { --accent:#bd6cff; --accent-60:rgba(189,108,255,.60); --accent-28:rgba(189,108,255,.28); --accent-18:rgba(189,108,255,.18); --accent-10:rgba(189,108,255,.10); }
  .room-cyan    { --accent:#46eaff; --accent-60:rgba(70,234,255,.60);  --accent-28:rgba(70,234,255,.28);  --accent-18:rgba(70,234,255,.18); --accent-10:rgba(70,234,255,.10); }
  .room-magenta { --accent:#ff0fd6; --accent-60:rgba(255,15,214,.60); --accent-28:rgba(255,15,214,.28); --accent-18:rgba(255,15,214,.18); --accent-10:rgba(255,15,214,.10); }
  .room-gold    { --accent:#ffd166; --accent-60:rgba(255,209,102,.60); --accent-28:rgba(255,209,102,.28); --accent-18:rgba(255,209,102,.18); --accent-10:rgba(255,209,102,.10); }
  .room-lime    { --accent:#86ff82; --accent-60:rgba(134,255,130,.60); --accent-28:rgba(134,255,130,.28); --accent-18:rgba(134,255,130,.18); --accent-10:rgba(134,255,130,.10); }
  .room-rose    { --accent:#ff7aa2; --accent-60:rgba(255,122,162,.60); --accent-28:rgba(255,122,162,.28); --accent-18:rgba(255,122,162,.18); --accent-10:rgba(255,122,162,.10); }
  .room-orange  { --accent:#ff9b4a; --accent-60:rgba(255,155,74,.60);  --accent-28:rgba(255,155,74,.28);  --accent-18:rgba(255,155,74,.18);  --accent-10:rgba(255,155,74,.10); }
  .room-blue    { --accent:#6ab8ff; --accent-60:rgba(106,184,255,.60); --accent-28:rgba(106,184,255,.28); --accent-18:rgba(106,184,255,.18); --accent-10:rgba(106,184,255,.10); }

  @media (prefers-reduced-motion: reduce){
    #matrix,#bubbles,#hammerfx{ display:none; }
  }

  /* ====== ENGINE ROOM SPECIALS ====== */
  .hammer-wrap{
    position:absolute; inset:0; display:grid; place-items:center;
  }
  .hammer-spot{
    width: 36vmin; height: 20vmin; border-radius: 50%;
    background: radial-gradient(ellipse at center, rgba(0,0,0,.85) 0%, rgba(0,0,0,0) 70%);
    position:absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
    pointer-events:none;
  }
  .hammer-svg{
    width:min(38vmin, 70%); height:auto; filter: drop-shadow(0 8px 28px rgba(0,0,0,.65));
  }
</style>
</head>
<body>

<!-- FX layers -->
<canvas id="matrix" class="fx-layer"></canvas>
<canvas id="bubbles" class="fx-layer"></canvas>
<canvas id="hammerfx" class="fx-layer"></canvas> <!-- lightning for Engine Room only -->
<div class="halo" id="halo"></div>

<!-- Arrows -->
<a class="arrow left"  href="#prev" aria-label="Previous room">◀</a>
<a class="arrow right" href="#next" aria-label="Next room">▶</a>

<main>
  <!-- ===== Engine Room is now DEFAULT (Room 1) ===== -->
  <section data-room="room1" class="room-engine on">
    <h1 class="title">Engine Room</h1>
    <p class="subtitle">Green Matrix • Thor’s Hammer • Lightning</p>
    <div class="brand">Elevator Online • Green Core Warm</div>

    <!-- Hammer Stage (centered) -->
    <div class="stage" data-video="aqz-KE-bpKQ" id="engine-stage">
      <div class="hammer-wrap">
        <div class="hammer-spot"></div>
        <!-- Simple, clean SVG Mjölnir (no external assets) -->
        <svg class="hammer-svg" viewBox="0 0 220 220" aria-hidden="true">
          <!-- Head -->
          <rect x="40" y="40" width="140" height="70" rx="12" ry="12" fill="#c9ced1"/>
          <rect x="55" y="55" width="110" height="40" rx="8" ry="8" fill="#e7ebee"/>
          <!-- Neck -->
          <rect x="98" y="110" width="24" height="18" rx="6" ry="6" fill="#b5b9bc"/>
          <!-- Handle -->
          <rect x="90" y="128" width="40" height="64" rx="10" ry="10" fill="#6a4b3a"/>
          <!-- Grip rings -->
          <g fill="#865c45">
            <rect x="90" y="138" width="40" height="6" rx="3"/>
            <rect x="90" y="154" width="40" height="6" rx="3"/>
            <rect x="90" y="170" width="40" height="6" rx="3"/>
          </g>
          <!-- Pommel -->
          <circle cx="110" cy="196" r="10" fill="#4b3429"/>
          <!-- Glint -->
          <rect x="50" y="48" width="18" height="6" rx="3" fill="white" opacity=".65"/>
        </svg>
      </div>
    </div>

    <div class="joke">“If it sparks, it works.”</div>

    <!-- Add Link for Engine Room video -->
    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room1"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room1">
      <div class="sheet-inner">
        <label for="input-room1">Paste a YouTube link or ID (Engine Room video):</label>
        <input id="input-room1" type="url" inputmode="url" placeholder="https://youtu.be/VIDEO or ID">
        <div class="actions">
          <button class="btn primary" data-apply="room1">Set Video</button>
          <button class="btn" data-reset="room1">Reset to Default</button>
          <span class="hint">Room 1 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 2 — Purple Play (Suno A) -->
  <section data-room="room2" class="room-purple">
    <h1 class="title">Purple Play</h1>
    <p class="subtitle">Suno Room A • 5 links</p>
    <div class="brand">Timmy Bubbles • Creator-Safe</div>
    <div class="stage" data-video="Zi_XLOBDo_Y"></div>
    <ul class="links">
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/bb594ef1-d260-46b7-af7f-e3a3286d39b1">Vibe 1 — Laugh</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/2ec04889-1c23-4e2d-9c27-8a2b6475da4b">Vibe 2 — Play</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/e95ddd12-7e37-43e2-b3e0-fe342085a19f">Vibe 3 — Fun</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/c387adf4-abdb-4f74-9075-c4cb460c8840">Vibe 4 — Motown</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/34190a09-abb2-470d-85a5-a1201f5e827c">Vibe 5 — Feeling It</a></li>
    </ul>
    <div class="joke">“Certified bop, zero copyright flop.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room2"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room2">
      <div class="sheet-inner">
        <label for="input-room2">Paste a YouTube link or ID:</label>
        <input id="input-room2" type="url" inputmode="url" placeholder="https://youtube.com/shorts/VIDEO">
        <div class="actions">
          <button class="btn primary" data-apply="room2">Set Video</button>
          <button class="btn" data-reset="room2">Reset to Default</button>
          <span class="hint">Room 2 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 3 — Warm Core (Suno B) -->
  <section data-room="room3" class="room-cyan">
    <h1 class="title">Warm Core</h1>
    <p class="subtitle">Suno Room B • 5 links</p>
    <div class="brand">Terrific Timmy • Feel Good</div>
    <div class="stage" data-video="3JZ_D3ELwOQ"></div>
    <ul class="links">
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/b11f5b9a-b2d1-46f2-a307-e62491ae2479">Suno Set 1</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/d04a7c63-52b7-4695-b47f-64f3a3dae677">Suno Set 2</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/06b80fa9-8c72-4e0a-b277-88d00c441316">Suno Set 3</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/3a82341f-95df-4b1b-91a2-4d5e6531ae08">Suno Set 4</a></li>
      <li><a target="_blank" rel="noopener" href="https://suno.com/playlist/d3ed7e46-ea14-477f-a9cf-051bdfc0c9c3">Suno Set 5</a></li>
    </ul>
    <div class="joke">“10/10 doctors recommend more vibes.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room3"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room3">
      <div class="sheet-inner">
        <label for="input-room3">Paste a YouTube link or ID:</label>
        <input id="input-room3" type="url" inputmode="url" placeholder="https://youtube.com/watch?v=VIDEO">
        <div class="actions">
          <button class="btn primary" data-apply="room3">Set Video</button>
          <button class="btn" data-reset="room3">Reset to Default</button>
          <span class="hint">Room 3 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 4 — Magenta -->
  <section data-room="room4" class="room-magenta">
    <h1 class="title">Magenta Room</h1>
    <p class="subtitle">Electric glow • Center-stage marketing</p>
    <div class="brand">TimmyTime • Pink Neon Pulse</div>
    <div class="stage" data-video="dQw4w9WgXcQ"></div>
    <div class="joke">“If the bubbles are vibing, we’re already on page 2 of awesome.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room4"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room4">
      <div class="sheet-inner">
        <label for="input-room4">Paste a YouTube link (watch / shorts / youtu.be) or an ID:</label>
        <input id="input-room4" type="url" inputmode="url" placeholder="https://youtu.be/VIDEO or https://youtube.com/watch?v=VIDEO">
        <div class="actions">
          <button class="btn primary" data-apply="room4">Set Video</button>
          <button class="btn" data-reset="room4">Reset to Default</button>
          <span class="hint">Room 4 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 5 -->
  <section data-room="room5" class="room-gold">
    <h1 class="title">Gold Rush</h1>
    <p class="subtitle">Reels + Marketing</p>
    <div class="brand">Tornado Timmy • Spin Up</div>
    <div class="stage" data-video="l482T0yNkeo"></div>
    <div class="joke">“Breaking news: bubbles rise.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room5"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room5">
      <div class="sheet-inner">
        <label for="input-room5">Paste a YouTube link or ID:</label>
        <input id="input-room5" type="url" inputmode="url" placeholder="VIDEO id or URL">
        <div class="actions">
          <button class="btn primary" data-apply="room5">Set Video</button>
          <button class="btn" data-reset="room5">Reset to Default</button>
          <span class="hint">Room 5 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 6 -->
  <section data-room="room6" class="room-lime">
    <h1 class="title">Lime Lift</h1>
    <p class="subtitle">Quotes / Love</p>
    <div class="brand">Timmy Fantastic</div>
    <div class="stage" data-video="9bZkp7q19f0"></div>
    <div class="joke">“Free refills on smiles.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room6"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room6">
      <div class="sheet-inner">
        <label for="input-room6">Paste a YouTube link or ID:</label>
        <input id="input-room6" type="url" inputmode="url" placeholder="VIDEO id or URL">
        <div class="actions">
          <button class="btn primary" data-apply="room6">Set Video</button>
          <button class="btn" data-reset="room6">Reset to Default</button>
          <span class="hint">Room 6 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 7 -->
  <section data-room="room7" class="room-rose">
    <h1 class="title">Rose Bloom</h1>
    <p class="subtitle">Reels + Jokes</p>
    <div class="brand">TimmyTime LIVE</div>
    <div class="stage" data-video="fJ9rUzIMcZQ"></div>
    <div class="joke">“Comedy calories don’t count.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room7"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room7">
      <div class="sheet-inner">
        <label for="input-room7">Paste a YouTube link or ID:</label>
        <input id="input-room7" type="url" inputmode="url" placeholder="VIDEO id or URL">
        <div class="actions">
          <button class="btn primary" data-apply="room7">Set Video</button>
          <button class="btn" data-reset="room7">Reset to Default</button>
          <span class="hint">Room 7 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 8 -->
  <section data-room="room8" class="room-orange">
    <h1 class="title">Orange Drive</h1>
    <p class="subtitle">Center-Stage + Link bar</p>
    <div class="brand">Creator Mode • One-Take</div>
    <div class="stage" data-video="J---aiyznGQ"></div>
    <div class="joke">“One button, instant swagger.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room8"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room8">
      <div class="sheet-inner">
        <label for="input-room8">Paste a YouTube link or ID:</label>
        <input id="input-room8" type="url" inputmode="url" placeholder="VIDEO id or URL">
        <div class="actions">
          <button class="btn primary" data-apply="room8">Set Video</button>
          <button class="btn" data-reset="room8">Reset to Default</button>
          <span class="hint">Room 8 only (local)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 9 -->
  <section data-room="room9" class="room-blue">
    <h1 class="title">Blue Calm (Beta Lab)</h1>
    <p class="subtitle">Experiments • Chill</p>
    <div class="brand">Spark • Test • Ship</div>
    <div class="stage" data-video="60ItHLz5WEA"></div>
    <div class="joke">“Shipping is a feature.”</div>

    <div class="plus-wrap">
      <button class="plus-btn" data-linker="#linker-room9"><span class="dot">＋</span> Add Link</button>
    </div>
    <div class="sheet" id="linker-room9">
      <div class="sheet-inner">
        <label for="input-room9">Paste a YouTube link or ID:</label>
        <input id="input-room9" type="url" inputmode="url" placeholder="VIDEO id or URL">
        <div class="actions">
          <button class="btn primary" data-apply="room9">Set Video</button>
          <button class="btn" data-reset="room9">Reset to Default</button>
          <span class="hint">Room 9 only (local)</span>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="ship-toast"></div>

<script>
/* =========================
   SPA Router + Video Mount
   ========================= */
const ROOMS = ["room1","room2","room3","room4","room5","room6","room7","room8","room9"];
const DEFAULT_ROOM = "room1"; // ENGINE ROOM LANDS FIRST

/* YouTube ID parser */
function ytIdFrom(input){
  if (!input) return "";
  let s = (""+input).trim();
  if (/^[A-Za-z0-9_-]{11}$/.test(s)) return s;
  try{
    const u = new URL(s);
    const host = u.hostname.replace(/^www\./,"");
    if (host === "youtu.be"){ return u.pathname.split("/").filter(Boolean)[0] || ""; }
    if (host.includes("youtube.com")){
      const v = u.searchParams.get("v");
      if (v) return v;
      if (u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2] || "";
      if (u.pathname.startsWith("/embed/"))  return u.pathname.split("/")[2] || "";
    }
  }catch(e){}
  s = s.split(/[?&]/)[0];
  if (/^[A-Za-z0-9_-]{11}$/.test(s)) return s;
  return "";
}

/* localStorage helpers */
function keyFor(room){ return `timmy:room:${room}:video`; }
function saveVideo(room, vid){ try{ localStorage.setItem(keyFor(room), vid); }catch(e){} }
function loadVideo(room){ try{ return localStorage.getItem(keyFor(room)) || ""; }catch(e){ return ""; } }
function clearVideo(room){ try{ localStorage.removeItem(keyFor(room)); }catch(e){} }

/* Build an iframe from data-video or stored override */
function mountVideoFor(roomId){
  const section = document.querySelector(`[data-room="${roomId}"]`);
  if (!section) return;
  const stage = section.querySelector(".stage");
  if (!stage) return;
  const stored = loadVideo(roomId);
  const vid = stored || stage.getAttribute("data-video") || "";
  const src = vid ? `https://www.youtube.com/embed/${vid}?rel=0` : "";
  stage.innerHTML = vid ? `<iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen src="${src}"></iframe>` : "";
  stage.dataset.mounted = "1";
}

function showRoom(id){
  const room = ROOMS.includes(id) ? id : DEFAULT_ROOM;
  document.querySelectorAll("[data-room]").forEach(el=>el.classList.remove("on"));
  const el = document.querySelector(`[data-room="${room}"]`);
  if (el) el.classList.add("on");

  if (location.hash.slice(1) !== room) history.replaceState(null, "", "#"+room);

  // Theme sync
  document.body.className = "";
  el.classList.forEach(c=>{ if (c.startsWith("room-")) document.body.classList.add(c); });

  // Videos
  mountVideoFor(room);

  // Lightning canvas only when Engine Room is visible
  const hammerfx = document.getElementById("hammerfx");
  hammerfx.style.display = (room === "room1") ? "block" : "none";
}

function currentIndex(){
  const now = location.hash.slice(1);
  return Math.max(0, ROOMS.indexOf(ROOMS.includes(now) ? now : DEFAULT_ROOM));
}
function go(delta){
  const i = currentIndex();
  const j = (i + delta + ROOMS.length) % ROOMS.length;
  location.hash = "#"+ROOMS[j];
}
document.querySelector(".arrow.left").addEventListener("click", e=>{ e.preventDefault(); go(-1); });
document.querySelector(".arrow.right").addEventListener("click", e=>{ e.preventDefault(); go(+1); });
addEventListener("hashchange", ()=> showRoom(location.hash.slice(1)));
showRoom(location.hash.slice(1) || DEFAULT_ROOM);

/* =========================
   Bubbles — brighter outlines
   ========================= */
const bc = document.getElementById("bubbles");
const bctx = bc.getContext("2d");
let BW=0,BH=0,bubbles=[];
function bResize(){
  const dpr = Math.min(devicePixelRatio || 1, 2);
  BW = bc.width = Math.floor(innerWidth * dpr);
  BH = bc.height = Math.floor(innerHeight * dpr);
  bc.style.width = "100%"; bc.style.height = "100%";
  bctx.lineWidth = 1.2 * dpr;
}
function seedBubbles(n=90){
  const dpr = Math.min(devicePixelRatio || 1, 2);
  bubbles = Array.from({length:n}, ()=>({
    x: Math.random()*BW,
    y: Math.random()*BH,
    r: (Math.random()*24+14)*dpr,
    s: Math.random()*0.7+0.25,
    a: Math.random()*0.14+0.12
  }));
}
function bubbleStrokeStyle(){
  const cs = getComputedStyle(document.body);
  return cs.getPropertyValue("--accent-60").trim() || "rgba(255,255,255,.45)";
}
function drawBubbles(){
  bctx.clearRect(0,0,BW,BH);
  bctx.globalCompositeOperation = "lighter";
  bctx.strokeStyle = bubbleStrokeStyle();
  for(const b of bubbles){
    b.y -= b.s * 1.1;
    if (b.y + b.r < 0){ b.y = BH + b.r; b.x = Math.random()*BW; }
    bctx.globalAlpha = Math.min(.26, b.a);
    bctx.beginPath(); bctx.arc(b.x, b.y, b.r, 0, Math.PI*2); bctx.stroke();
  }
  requestAnimationFrame(drawBubbles);
}
bResize(); seedBubbles();
addEventListener("resize", bResize, {passive:true});
drawBubbles();

/* =========================
   Matrix drizzle — room-tinted
   ========================= */
const mc = document.getElementById("matrix");
const mctx = mc.getContext("2d");
function mResize(){
  const dpr = Math.min(devicePixelRatio || 1, 2);
  mc.width = Math.floor(innerWidth * dpr);
  mc.height = Math.floor(innerHeight * dpr);
  mc.style.width = "100%"; mc.style.height = "100%";
}
mResize(); addEventListener("resize", mResize, {passive:true});
function matrixTint(){
  const cs = getComputedStyle(document.body);
  return cs.getPropertyValue("--accent-18").trim() || "rgba(0,255,120,.18)";
}
function matrixLoop(){
  mctx.fillStyle = "rgba(0,0,0,0.04)";
  mctx.fillRect(0,0,mc.width,mc.height);
  const tint = matrixTint();
  for (let k=0;k<6;k++){
    const x = Math.random()*mc.width;
    const y = Math.random()*mc.height;
    const h = (Math.random()*70+28);
    mctx.fillStyle = tint;
    mctx.fillRect(x, y, 2, h);
  }
  requestAnimationFrame(matrixLoop);
}
matrixLoop();

/* =========================
   Engine Room Lightning (Mjölnir)
   ========================= */
const hfx = document.getElementById("hammerfx");
const hctx = hfx.getContext("2d");
function hResize(){
  const dpr = Math.min(devicePixelRatio || 1, 2);
  hfx.width = Math.floor(innerWidth * dpr);
  hfx.height = Math.floor(innerHeight * dpr);
  hfx.style.width = "100%"; hfx.style.height = "100%";
}
hResize(); addEventListener("resize", hResize, {passive:true});

function bolt(x1,y1,x2,y2,seg=10,spread=28){
  const pts = [{x:x1,y:y1}];
  for(let i=1;i<seg;i++){
    const t = i/seg;
    const x = x1 + (x2-x1)*t + (Math.random()*2-1)*spread*(1-Math.abs(.5-t)*2);
    const y = y1 + (y2-y1)*t + (Math.random()*2-1)*spread;
    pts.push({x,y});
  }
  pts.push({x:x2,y:y2});
  hctx.beginPath();
  hctx.moveTo(pts[0].x, pts[0].y);
  for(const p of pts.slice(1)) hctx.lineTo(p.x,p.y);
  hctx.stroke();
}

let lastStrike = 0;
function lightningLoop(ts){
  const now = performance.now();
  hctx.clearRect(0,0,hfx.width,hfx.height);

  // Strike occasionally when Engine Room is active
  const engineVisible = document.querySelector('[data-room="room1"]').classList.contains('on');
  if (engineVisible && (now - lastStrike) > (1500 + Math.random()*2500)){
    lastStrike = now;

    const cx = hfx.width/2, cy = hfx.height*0.38;
    hctx.lineWidth = 2 * Math.min(devicePixelRatio||1,2);
    hctx.shadowBlur = 24;
    hctx.shadowColor = "rgba(180,255,255,.9)";
    hctx.strokeStyle = "rgba(210,255,255,.95)";
    // Primary bolt from top toward center of stage/hammer
    bolt(cx, 0, cx + (Math.random()*120-60), cy + (Math.random()*40-20), 14, 34);
    // Small branches
    hctx.lineWidth = 1.2 * Math.min(devicePixelRatio||1,2);
    bolt(cx, hfx.height*0.12, cx-120, cy-30, 8, 24);
    bolt(cx, hfx.height*0.16, cx+140, cy-10, 8, 24);
  }

  requestAnimationFrame(lightningLoop);
}
lightningLoop();

/* =========================
   Add Link UI (per-room)
   ========================= */
function toast(msg){
  const t = document.getElementById("ship-toast");
  t.textContent = msg; t.style.opacity = "1";
  setTimeout(()=> t.style.opacity = "0", 1600);
}
// Toggle sheets
document.querySelectorAll(".plus-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const sel = btn.getAttribute("data-linker");
    const sheet = document.querySelector(sel);
    if (sheet) sheet.classList.toggle("on");
  });
});
// Apply / Reset buttons
document.querySelectorAll("[data-apply]").forEach(b=>{
  b.addEventListener("click", ()=>{
    const room = b.getAttribute("data-apply");
    const input = document.getElementById(`input-${room}`);
    if (!input) return;
    const id = ytIdFrom(input.value);
    if (!id){ toast("Hmm… couldn’t read that link."); return; }
    saveVideo(room, id);
    mountVideoFor(room);
    toast("Video updated for this room.");
  });
});
document.querySelectorAll("[data-reset]").forEach(b=>{
  b.addEventListener("click", ()=>{
    const room = b.getAttribute("data-reset");
    clearVideo(room);
    mountVideoFor(room);
    toast("Back to default video.");
  });
});
</script>
</body>
</html>
